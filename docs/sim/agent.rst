.. _agent:

Building an Agent
=================

Users may customize their agents using :class:`smarts.zoo.agent_spec.AgentSpec` which includes the following fields:

.. code-block:: python

    class AgentSpec:
        interface: AgentInterface
        agent_builder: Callable[..., Agent] = None
        agent_params: Optional[Any] = None

An example of how to create an ``Agent`` instance is shown below.

.. code-block:: python

    AgentSpec(
      interface=AgentInterface.from_type(
        requested_type=AgentType.Standard, 
        max_episode_steps=500,
      ),
      agent_builder=lambda: Agent.from_function(lambda _: "keep_lane"),
    )

    agent = agent_spec.build_agent()

The fields of :class:`smarts.core.agent.Agent` class is further explained later on this page.

Agent Interface
---------------

:class:`smarts.core.agent_interface.AgentInterface` regulates information flow between the agent and a SMARTS environment. 
It specifies (a) the expected observation from the environment to the agent, and (b) the expected action from the agent to the environment.

SMARTS provides several pre-designed agent interfaces for ease of use. The interface options are shown in the table below.

+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **Agent Interface**        | :attr:`smarts.core.agent_interface.AgentType.Full`         | :attr:`smarts.core.agent_interface.AgentType.StandardWithAbsoluteSteering` | :attr:`smarts.core.agent_interface.AgentType.Standard`          | :attr:`smarts.core.agent_interface.AgentType.Laner`  | :attr:`smarts.core.agent_interface.AgentType.LanerWithSpeed`            | :attr:`smarts.core.agent_interface.AgentType.Tracker`      | :attr:`smarts.core.agent_interface.AgentType.TrajectoryInterpolator` | :attr:`smarts.core.agent_interface.AgentType.MPCTracker` | :attr:`smarts.core.agent_interface.AgentType.Boid`              | :attr:`smarts.core.agent_interface.AgentType.Loner`        | :attr:`smarts.core.agent_interface.AgentType.Tagger`       | :attr:`smarts.core.agent_interface.AgentType.Direct`   |
+============================+============================================================+============================================================================+=================================================================+======================================================+=========================================================================+============================================================+======================================================================+==========================================================+=================================================================+============================================================+============================================================+========================================================+
| **action**                 | :attr:`smarts.core.controllers.ActionSpaceType.Continuous` | :attr:`smarts.core.controllers.ActionSpaceType.Continuous`                 | :attr:`smarts.core.controllers.ActionSpaceType.ActuatorDynamic` | :attr:`smarts.core.controllers.ActionSpaceType.Lane` | :attr:`smarts.core.controllers.ActionSpaceType.LaneWithContinuousSpeed` | :attr:`smarts.core.controllers.ActionSpaceType.Trajectory` | :attr:`smarts.core.controllers.ActionSpaceType.TrajectoryWithTime`   | :attr:`smarts.core.controllers.ActionSpaceType.MPC`      | :attr:`smarts.core.controllers.ActionSpaceType.MultiTargetPose` | :attr:`smarts.core.controllers.ActionSpaceType.Continuous` | :attr:`smarts.core.controllers.ActionSpaceType.Continuous` | :attr:`smarts.core.controllers.ActionSpaceType.Direct` |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **max_episode_steps**      | ✓                                                          | ✓                                                                          | ✓                                                               | ✓                                                    | ✓                                                                       | ✓                                                          | ✓                                                                    | ✓                                                        | ✓                                                               | ✓                                                          | ✓                                                          | ✓                                                      |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **neighborhood_vehicles**  | ✓                                                          | ✓                                                                          | ✓                                                               |                                                      |                                                                         |                                                            |                                                                      |                                                          | ✓                                                               |                                                            | ✓                                                          | ✓                                                      |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **waypoints**              | ✓                                                          | ✓                                                                          | ✓                                                               | ✓                                                    | ✓                                                                       | ✓                                                          |                                                                      | ✓                                                        | ✓                                                               | ✓                                                          | ✓                                                          |                                                        |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **drivable_area_grid_map** | ✓                                                          |                                                                            |                                                                 |                                                      |                                                                         |                                                            |                                                                      |                                                          |                                                                 |                                                            |                                                            |                                                        |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **ogm**                    | ✓                                                          |                                                                            |                                                                 |                                                      |                                                                         |                                                            |                                                                      |                                                          |                                                                 |                                                            |                                                            |                                                        |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **rgb**                    | ✓                                                          |                                                                            |                                                                 |                                                      |                                                                         |                                                            |                                                                      |                                                          |                                                                 |                                                            |                                                            |                                                        |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **lidar**                  | ✓                                                          |                                                                            |                                                                 |                                                      |                                                                         |                                                            |                                                                      |                                                          |                                                                 |                                                            |                                                            |                                                        |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **accelerometer**          | ✓                                                          | ✓                                                                          | ✓                                                               | ✓                                                    | ✓                                                                       | ✓                                                          | ✓                                                                    | ✓                                                        | ✓                                                               | ✓                                                          | ✓                                                          | ✓                                                      |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **signals**                | ✓                                                          |                                                                            |                                                                 |                                                      |                                                                         |                                                            |                                                                      |                                                          |                                                                 |                                                            |                                                            | ✓                                                      |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+
| **debug**                  | ✓                                                          | ✓                                                                          | ✓                                                               | ✓                                                    | ✓                                                                       | ✓                                                          | ✓                                                                    | ✓                                                        | ✓                                                               | ✓                                                          | ✓                                                          | ✓                                                      |
+----------------------------+------------------------------------------------------------+----------------------------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------+-------------------------------------------------------------------------+------------------------------------------------------------+----------------------------------------------------------------------+----------------------------------------------------------+-----------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+--------------------------------------------------------+

Here,

+ ``action`` controls the action type used and there are multiple action types to choose from :class:`smarts.core.controllers.ActionSpaceType`.
+ ``max_episode_steps`` controls the max steps allowed for the agent in an episode. Defaults to ``None``, implies agent has no step limit.

  .. note:: 
    
    While using RLlib, the ``max_episode_steps`` control authority may be ceded to RLlib through their config option ``horizon``, but doing so 
    removes the ability to customize different max episode steps for each agent.

Do the following to create and extend an agent interface using a pre-designed interface.

.. code-block:: python

    agent_interface = AgentInterface.from_type(
        requested_type = AgentType.Standard,
        max_episode_steps = 1000, 
        ...
    )

Alternatively, users may customize their ``agent_interface`` from scratch, like:

.. code-block:: python

    from smarts.core.agent_interface import AgentInterface
    from smarts.core.controllers import ActionSpaceType

    agent_interface = AgentInterface(
        max_episode_steps=1000,
        waypoints=True,
        neighborhood_vehicles=True,
        drivable_area_grid_map=True,
        ogm=True,
        rgb=True,
        lidar=False,
        action=ActionSpaceType.Continuous,
    )

Further customization of individual interface options of :class:`smarts.core.agent_interface` is also possible.

.. code-block:: python

    from smarts.core.agent_interface import AgentInterface, NeighborhoodVehicles, RGB, Waypoints
    from smarts.core.controllers import ActionSpaceType

    agent_interface = AgentInterface(
        max_episode_steps=1000,
        waypoints=Waypoints(lookahead=50), # Lookahead 50 meters.
        neighborhood_vehicles=NeighborhoodVehicles(radius=50), # Get neighborhood vehicles within 50 meters.
        drivable_area_grid_map=True,
        ogm=True,
        rgb=RGB(height=128,width=128,resolution=100/128), # 128x128 pixels RGB image representing a 100x100 meters area.
        lidar=False,
        action=ActionSpaceType.Continuous,
    )

.. important::

    Generation of a drivable area grid map (``drivable_area_grid_map=True``), occupancy grid map (``ogm=True``), and RGB (``rgb=True``) images, may significantly slow down the environment ``step()``. 
    It is recommended to set these image renderings to ``False`` if the agent policy does not require such observations.

Agent
-----

An agent maps an observation to an action.

.. code-block:: python

    # A simple agent that ignores observations
    class IgnoreObservationsAgent(Agent):
        def act(self, obs):
            return [throttle, brake, steering_rate]

The observation passed in is the observations that a given agent sees. 
In **continuous action space** the action is expected to produce values for 
:math:`throttle ∈ [0,1]`, :math:`brake ∈ [0,1]`, and :math:`steering\_rate ∈ [-1,1]`.

Otherwise, only while using **lane action space**, the agent is expected to return a lane related command: ``"keep_lane"``, ``"slow_down"``, ``"change_lane_left"``, ``"change_lane_right"``.

Another example:

.. literalinclude:: ./minimal_agent.py
   :language: python

Spaces
------

Spaces provide samples for variation. For reference, see `gymnasium <https://gymnasium.farama.org/api/spaces/>`_ .

.. code-block:: python

    # Observation space should match the observation. An example observation
    # space is as follows, if the observation only consists of speed and 
    # steering values.
    OBSERVATION_SPACE = gym.spaces.Dict(
    {
        "speed": gym.spaces.Box(low=-1e10, high=1e10, shape=(1,)),
        "steering": gym.spaces.Box(low=-1e10, high=1e10, shape=(1,)),        
    }

Observations can be customized. Some example customizations are provided in 
:class:`smarts.env.custom_observations`.